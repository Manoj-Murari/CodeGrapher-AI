<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeGrapher AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --bg-primary-light: #F9FAFB; --bg-secondary-light: #FFFFFF; --bg-tertiary-light: #F3F4F6; --text-primary-light: #111827; --text-secondary-light: #6B7280; --border-light: #E5E7EB; --accent-light: #2563EB; --accent-hover-light: #1D4ED8;
            --bg-primary-dark: #111827; --bg-secondary-dark: #1F2937; --bg-tertiary-dark: #374151; --text-primary-dark: #F9FAFB; --text-secondary-dark: #9CA3AF; --border-dark: #374151; --accent-dark: #3B82F6; --accent-hover-dark: #60A5FA;
        }
        html.light { --bg-primary: var(--bg-primary-light); --bg-secondary: var(--bg-secondary-light); --bg-tertiary: var(--bg-tertiary-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border: var(--border-light); --accent: var(--accent-light); --accent-hover: var(--accent-hover-light); }
        html.dark { --bg-primary: var(--bg-primary-dark); --bg-secondary: var(--bg-secondary-dark); --bg-tertiary: var(--bg-tertiary-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border: var(--border-dark); --accent: var(--accent-dark); --accent-hover: var(--accent-hover-dark); }
        * { box-sizing: border-box; }
        body { font-family: var(--font-sans); background-color: var(--bg-primary); color: var(--text-primary); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background-color 0.2s ease, color 0.2s ease; }
        .main-container { display: flex; flex-direction: column; flex-grow: 1; height: 100vh; }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .theme-toggle { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 0.5rem; border-radius: 99px; }
        .theme-toggle:hover { background-color: var(--bg-tertiary); }
        .theme-toggle svg { width: 1.25rem; height: 1.25rem; }
        #project-selector { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.25rem 0.5rem; font-family: var(--font-sans); font-size: 0.875rem; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 1rem 0; }
        .chat-content { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; }
        .welcome-screen { text-align: center; margin-top: 15vh; }
        .welcome-screen .logo { font-size: 3rem; margin-bottom: 1rem; }
        .welcome-screen h2 { font-size: 1.75rem; font-weight: 600; margin-bottom: 2rem; }
        .example-prompts { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; }
        .prompt-card { background-color: var(--bg-secondary); padding: 1rem; border-radius: 0.75rem; border: 1px solid var(--border); cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; text-align: left; width: 200px; }
        .prompt-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .prompt-card .title { font-weight: 600; margin-bottom: 0.5rem; }
        .prompt-card .subtitle { font-size: 0.875rem; color: var(--text-secondary); }
        .message { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .message.user { justify-content: flex-end; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 500; flex-shrink: 0; }
        .avatar.user-avatar { background-color: #7C3AED; color: white; }
        .avatar.agent-avatar { background-color: #16A34A; color: white; }
        .message-content { max-width: calc(100% - 48px); padding-top: 0.5rem; width: 100%; }
        .message.user .message-content { text-align: right; }
        .message-body { background-color: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 0.75rem; border: 1px solid var(--border); white-space: pre-wrap; word-wrap: break-word; text-align: left; display: inline-block; }
        .message.user .message-body { background-color: var(--accent); color: white; border: none; border-top-right-radius: 0.25rem; }
        .message.agent .message-body { border-top-left-radius: 0.25rem; }
        .message-body p:first-child { margin-top: 0; }
        .message-body p:last-child { margin-bottom: 0; }
        .agent-work-container { margin-top: 0.75rem; text-align: left;}
        .agent-work-toggle { font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 99px; padding: 0.25rem 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.25rem; }
        .agent-work-toggle svg { width: 12px; height: 12px; transition: transform 0.2s ease; }
        .agent-work-toggle.expanded svg { transform: rotate(90deg); }
        .agent-work-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: var(--bg-tertiary); border-radius: 0.5rem; margin-top: 0.5rem; text-align: left;}
        .agent-work-details.expanded { max-height: 500px; overflow-y: auto; }
        .work-step { padding: 0.75rem 1rem; font-family: monospace; font-size: 0.8rem; border-bottom: 1px solid var(--border); white-space: pre-wrap; word-wrap: break-word; }
        .work-step:last-child { border-bottom: none; }
        pre { background-color: #0d1117; border-radius: 0.5rem; padding: 0; margin: 1rem 0; position: relative; }
        .code-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; font-size: 0.8rem; color: #8D96A0; background-color: #161b22; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .copy-code-btn { background-color: transparent; border: none; color: #8D96A0; cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; display: flex; align-items: center; gap: 0.25rem; }
        .copy-code-btn:hover { background-color: #30363d; color: #c9d1d9; }
        pre code { display: block; padding: 1rem; overflow-x: auto; color: #c9d1d9; font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; }
        .input-area-container { flex-shrink: 0; background-color: var(--bg-secondary); padding: 1rem 0; border-top: 1px solid var(--border); }
        .input-area { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        #user-input { flex-grow: 1; padding: 0.75rem 1rem; border-radius: 0.75rem; border: 1px solid var(--border); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
        #user-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-hover); }
        #send-button, #stop-button { border: none; color: white; background-color: var(--accent); padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        #send-button:hover, #stop-button:hover { background-color: var(--accent-hover); }
        #send-button:disabled { background-color: var(--text-secondary); cursor: not-allowed; }
        #send-button svg, #stop-button svg { width: 1.25rem; height: 1.25rem; }
        .blinking-cursor { display: inline-block; width: 10px; height: 1.2em; background-color: var(--text-primary); animation: blink 1s step-end infinite; vertical-align: bottom; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: var(--text-primary); } }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="header">
            <div class="header-left">
                <h1>CodeGrapher AI</h1>
                <select id="project-selector" title="Select a project"></select>
            </div>
            <div class="header-right">
                <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-6.364-.386 1.591-1.591M3 12h2.25m.386-6.364 1.591 1.591"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display: none;"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"/></svg>
                </button>
            </div>
        </header>

        <div id="chat-container">
            <div class="chat-content" id="chat-box">
                <div class="welcome-screen" id="welcome-screen">
                    <div class="logo">🤖</div>
                    <h2>Welcome to CodeGrapher AI</h2>
                    <div class="example-prompts">
                        <div class="prompt-card" onclick="setPrompt('Explain the `User` model.')">
                            <div class="title">Explain a component</div>
                            <div class="subtitle">"Explain the `User` model."</div>
                        </div>
                        <div class="prompt-card" onclick="setPrompt('Read the contents of the main application file.')">
                             <div class="title">Read a file</div>
                             <div class="subtitle">"Read the main application file."</div>
                        </div>
                        <div class="prompt-card" onclick="setPrompt('Who are the callers of the `save` method?')">
                              <div class="title">Analyze Code Structure</div>
                              <div class="subtitle">"Who are the callers of the `save` method?"</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area-container">
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Ask about the selected codebase..." autocomplete="off">
                <button id="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                </button>
                <button id="stop-button" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z" /></svg>
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
    // --- 1. Get all DOM elements ---
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const stopButton = document.getElementById('stop-button');
    const welcomeScreen = document.getElementById('welcome-screen');
    const chatContainer = document.getElementById('chat-container');
    const themeToggle = document.getElementById('theme-toggle');
    const themeIconLight = document.getElementById('theme-icon-light');
    const themeIconDark = document.getElementById('theme-icon-dark');
    const projectSelector = document.getElementById('project-selector');

    let controller = null;

    // --- 2. Define all Helper Functions ---

    async function loadProjects() {
        try {
            const response = await fetch('/projects');
            if (!response.ok) throw new Error('Failed to fetch projects');
            const projects = await response.json();
            projectSelector.innerHTML = '';
            if (projects.length > 0) {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project;
                    option.textContent = project;
                    projectSelector.appendChild(option);
                });
                projectSelector.disabled = false;
            } else {
                const option = document.createElement('option');
                option.textContent = 'No projects indexed';
                projectSelector.appendChild(option);
                projectSelector.disabled = true;
            }
        } catch (error) {
            console.error('Error loading projects:', error);
            projectSelector.innerHTML = '<option>Error loading</option>';
            projectSelector.disabled = true;
        }
    }

    function applyTheme(theme) {
        document.documentElement.className = theme;
        themeIconLight.style.display = theme === 'dark' ? 'none' : 'block';
        themeIconDark.style.display = theme === 'dark' ? 'block' : 'none';
    }

    function toggleButtons(isLoading) {
        sendButton.disabled = isLoading;
        sendButton.style.display = isLoading ? 'none' : 'flex';
        stopButton.style.display = isLoading ? 'flex' : 'none';
    }

    function appendUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        messageDiv.innerHTML = `<div class="message-content"><div class="message-body">${text}</div></div><div class="avatar user-avatar">U</div>`;
        chatBox.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendAgentMessage() {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message agent';
        messageDiv.innerHTML = `<div class="avatar agent-avatar">AI</div><div class="message-content"><div class="message-body"><span class="blinking-cursor"></span></div><div class="agent-work-container"><button class="agent-work-toggle"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg> Show Work</button><div class="agent-work-details"></div></div></div>`;
        chatBox.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        const agentMessageBody = messageDiv.querySelector('.message-body');
        const agentWorkToggle = messageDiv.querySelector('.agent-work-toggle');
        const agentWorkDetails = messageDiv.querySelector('.agent-work-details');
        agentWorkToggle.onclick = () => {
            agentWorkDetails.classList.toggle('expanded');
            agentWorkToggle.classList.toggle('expanded');
        };
        return { agentMessageBody, agentWorkDetails };
    }

    function addCodeBlockFeatures(container) {
        const codeBlocks = container.querySelectorAll('pre');
        codeBlocks.forEach(pre => {
            const code = pre.querySelector('code');
            if (!code) return;
            // Guard against empty code blocks created by markdown parser
            if (pre.firstChild.nodeName === '#text' && !pre.firstChild.nodeValue.trim()) {
                 pre.firstChild.remove();
            }
            const langMatch = code.className.match(/language-(\S+)/);
            const lang = langMatch ? langMatch[1] : 'text';

            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `<span>${lang}</span><button class="copy-code-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1-1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg> <span>Copy</span></button>`;
            
            const copyBtn = header.querySelector('.copy-code-btn');
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(code.innerText).then(() => {
                    copyBtn.querySelector('span').innerText = 'Copied!';
                    setTimeout(() => { copyBtn.querySelector('span').innerText = 'Copy'; }, 2000);
                });
            });
            pre.insertBefore(header, pre.firstChild);
        });
    }

    function setPrompt(prompt) {
        userInput.value = prompt;
        userInput.focus();
        handleQuery();
    }

    // --- 3. The Main Query Handler ---
    async function handleQuery(questionOverride = null) {
        const question = questionOverride || userInput.value.trim();
        if (!question) return;

        const projectId = projectSelector.value;
        if (!projectId || projectSelector.disabled) {
            alert('Please select a valid project first.');
            return;
        }

        welcomeScreen.style.display = 'none';
        appendUserMessage(question);
        userInput.value = '';
        toggleButtons(true);
        const { agentMessageBody, agentWorkDetails } = appendAgentMessage();
        let fullResponse = '';
        controller = new AbortController();

        try {
            const response = await fetch('/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, project_id: projectId }),
                signal: controller.signal
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const events = buffer.split('\n\n');
                buffer = events.pop();

                for (const eventStr of events) {
                    if (eventStr.startsWith('data:')) {
                        const eventData = eventStr.substring(5).trim();
                        if (!eventData) continue;

                        try {
                            const data = JSON.parse(eventData);
                            if (data.type === 'thought') {
                                const stepDiv = document.createElement('div');
                                stepDiv.className = 'work-step';
                                stepDiv.textContent = data.content;
                                agentWorkDetails.appendChild(stepDiv);
                            } else if (data.type === 'chunk') {
                                fullResponse += data.content;
                                agentMessageBody.innerHTML = marked.parse(fullResponse + '<span class="blinking-cursor"></span>');
                            } else if (data.type === 'error') {
                                agentMessageBody.innerHTML = `<p style="color: #EF4444;">${data.content}</p>`;
                                break;
                            } else if (data.type === 'end') {
                                break;
                            }
                        } catch (e) {
                            console.error('Error parsing stream JSON:', eventData, e);
                        }
                    }
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                fullResponse += '\n\n[Generation stopped by user]';
            } else {
                console.error('Fetch request failed:', error);
                fullResponse = 'An error occurred connecting to the server.';
            }
        } finally {
            agentMessageBody.innerHTML = marked.parse(fullResponse);
            addCodeBlockFeatures(agentMessageBody);
            agentMessageBody.querySelectorAll('pre code').forEach((block) => {
                if(typeof hljs !== 'undefined') hljs.highlightElement(block);
            });
            toggleButtons(false);
            controller = null;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    // --- 4. Set up Event Listeners ---
    themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.className;
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    stopButton.addEventListener('click', () => {
        if (controller) controller.abort();
    });

    sendButton.addEventListener('click', () => handleQuery());
    
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleQuery();
        }
    });

    // --- 5. Initial Page Load Actions ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        loadProjects();
    });
</script>
</body>
</html>